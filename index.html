<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Invoice & ID Maker â€” PirateRuler</title>
<meta name="description" content="Invoice builder and ID card designer â€” client-side. Create invoices, design IDs, download or print â€” no uploads." />
<meta name="theme-color" content="#f7fbff" />
<link rel="icon" href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect rx="14" width="64" height="64" fill="%236b7dff"/><text x="50%" y="50%" font-family="Inter,Arial,sans-serif" font-weight="800" font-size="26" text-anchor="middle" alignment-baseline="central" fill="white">PR</text></svg>'>
<style>
  :root{
    --bg:#f3f7fb; --card:#ffffff; --muted:#6b7480; --text:#0b2130;
    --accent-start:#6b7dff; --accent-end:#0bb3ff;
    --glass: rgba(11,17,28,0.04);
    --radius:14px; --shadow-lg: 0 18px 50px rgba(3,12,30,0.18);
    --shadow-sm: 0 8px 24px rgba(3,12,30,0.08);
  }
  html.dark { --bg:#071225; --card:#061028; --muted:#98a7bf; --text:#e9f1ff; --accent-start:#5ab3ff; --accent-end:#6b7dff; }
  html.ocean { --bg:#e8f7fb; --card:#ffffff; --muted:#4f6b75; --text:#063242; --accent-start:#00c2d1; --accent-end:#2b9fff; }
  html.sunset{ --bg:#fff6f8; --card:#fff; --muted:#7a6b77; --text:#2a1020; --accent-start:#ff7aa2; --accent-end:#ffb86b; }

  *{box-sizing:border-box}
  body{
    margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    background: linear-gradient(180deg,var(--bg), #e9f6ff);
    color:var(--text); -webkit-font-smoothing:antialiased;
  }
  a{color:inherit;text-decoration:none} /* no underlines everywhere */
  .container{max-width:1280px;margin:14px auto;padding:18px;}

  /* Header */
  header.header{
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    padding:14px; border-radius:14px;
    background:linear-gradient(90deg, rgba(107,125,255,0.06), rgba(11,179,255,0.02));
    box-shadow:var(--shadow-sm);
  }
  .brand{display:flex;align-items:center;gap:12px;min-width:0}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent-start),var(--accent-end));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;font-size:20px;flex-shrink:0}
  .brand-text{min-width:0}
  .title-strong{font-weight:900;font-size:18px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .by{font-size:12px;color:var(--muted);margin-top:2px}

  .header-actions{display:flex;gap:10px;align-items:center}
  .btn{padding:9px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:800;background:transparent}
  .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--text)}
  .btn.theme{background:linear-gradient(90deg,var(--accent-start),var(--accent-end));color:white;border-radius:999px;padding:10px 16px}

  .hamb{width:46px;height:46px;border-radius:10px;background:var(--glass);display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid rgba(0,0,0,0.04)}

  /* Tabs / hero */
  .hero{margin-top:18px;padding:20px;border-radius:16px;background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.96));box-shadow:var(--shadow-lg)}
  .hero .big{font-size:28px;font-weight:900;margin:0}
  .hero .small{color:var(--muted);margin-top:8px}
  .tabs{display:flex;gap:10px;flex-wrap:wrap;margin-top:18px}
  .tab{padding:10px 16px;border-radius:999px;background:transparent;border:1px solid rgba(11,17,28,0.06);cursor:pointer;color:var(--muted);font-weight:700}
  .tab.active{background:linear-gradient(90deg,var(--accent-start),var(--accent-end));color:white;box-shadow:0 10px 30px rgba(11,107,255,0.12);transform:translateY(-4px)}

  /* main grid */
  .grid{display:grid;grid-template-columns:2fr 1fr;gap:18px;margin-top:12px;align-items:start}
  @media(max-width:980px){ .grid{grid-template-columns:1fr} }

  .card{background:var(--card);border-radius:14px;padding:18px;box-shadow:var(--shadow-sm);border:1px solid rgba(0,0,0,0.04)}
  .hint{color:var(--muted);font-size:13px;margin-bottom:10px}
  input[type="text"], input[type="number"], input[type="date"], select, textarea { width:100%; padding:12px;border-radius:10px;border:1px solid rgba(10,20,40,0.06); font-size:15px; background:transparent; color:var(--text); resize:vertical }
  .row{display:flex;gap:10px}
  .primary{background:linear-gradient(90deg,var(--accent-start),var(--accent-end));color:white;padding:9px 14px;border-radius:10px;border:none;font-weight:800;cursor:pointer}
  .ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);padding:9px 12px;border-radius:10px;cursor:pointer}

  /* invoice table */
  .table{width:100%;border-collapse:collapse;margin-top:12px}
  .table th, .table td{padding:10px;text-align:left;border-bottom:1px solid rgba(0,0,0,0.06)}
  .table th{font-weight:800;color:var(--muted)}
  .summary{margin-top:18px;text-align:right;font-weight:900}

  /* right panel */
  aside{align-self:start}
  .feature-panel{background:var(--card);border:1px solid rgba(0,0,0,0.06);border-radius:14px;box-shadow:var(--shadow-sm);padding:12px}
  @media(min-width:981px){ .feature-panel{position:sticky;top:18px;max-height:calc(100vh - 36px);overflow:auto} }

  .feature{display:flex;gap:12px;align-items:center;padding:12px;border-radius:12px;background:var(--card);border:1px solid rgba(0,0,0,0.06);box-shadow:var(--shadow-sm);min-height:90px}
  .f-icon{width:56px;height:56px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff;background:linear-gradient(135deg,var(--accent-start),var(--accent-end));flex-shrink:0}
  .f-title{font-weight:800}
  .f-desc{color:var(--muted);font-size:13px}

  /* sidebar specifics */
  .sidebar{position:fixed;top:0;right:0;height:100vh;width:360px;max-width:94vw;transform:translateX(120%);transition:transform .28s cubic-bezier(.2,.9,.3,1);z-index:90;background:var(--card);box-shadow:-40px 0 80px rgba(2,8,20,0.25);padding:20px;border-left:1px solid rgba(0,0,0,0.04);overflow:auto;border-radius:0 0 0 14px}
  .sidebar.open{transform:translateX(0)}
  .nav-list{margin-top:10px;display:flex;flex-direction:column;gap:12px}
  .nav-list a{display:block;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(0,0,0,0.01), rgba(0,0,0,0.02));color:var(--text);font-weight:600;text-decoration:none}
  .backup{margin-top:18px;color:var(--muted);font-size:13px}

  /* footer */
  footer{margin-top:18px;padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.92), rgba(255,255,255,0.96));text-align:center;box-shadow:var(--shadow-lg)}
  footer .visit{padding:10px 18px;border-radius:999px;background:linear-gradient(90deg,#ff7aa2 0%, #6b7dff 100%);color:#fff;font-weight:800;text-decoration:none;display:inline-block}

  /* small helpers */
  .muted{color:var(--muted)}
  .sm{font-size:13px;color:var(--muted)}
  .hidden{display:none}
</style>
</head>
<body>
<div class="container">

  <!-- Header -->
  <header class="header" role="banner">
    <div class="brand">
      <a href="/" aria-label="Home" style="display:flex;align-items:center;gap:12px">
        <div class="logo" aria-hidden="true">PR</div>
        <div class="brand-text">
          <div class="title-strong">Invoice & ID Maker</div>
          <div class="by">by PirateRuler.com</div>
        </div>
      </a>
    </div>

    <div class="header-actions" role="navigation">
      <div class="theme-select" id="themeSelectWrap">
        <button id="themeBtn" class="btn theme" title="Theme">Light â–¾</button>
        <div id="themeList" class="theme-list" aria-hidden="true" style="display:none;position:absolute;right:18px;top:72px;background:var(--card);border-radius:10px;padding:8px;box-shadow:var(--shadow-sm);z-index:1000;">
          <div class="theme-item" data-theme="light" style="padding:8px;cursor:pointer">Light</div>
          <div class="theme-item" data-theme="dark" style="padding:8px;cursor:pointer">Dark</div>
          <div class="theme-item" data-theme="ocean" style="padding:8px;cursor:pointer">Ocean</div>
          <div class="theme-item" data-theme="sunset" style="padding:8px;cursor:pointer">Sunset</div>
        </div>
      </div>

      <div id="hambBtn" class="hamb" title="Open menu" aria-haspopup="true" aria-controls="sidebar">â˜°</div>
    </div>
  </header>

  <!-- HERO + Tabs -->
  <section class="hero" aria-labelledby="heroTitle">
    <h1 id="heroTitle" class="big">Invoice Builder & ID Designer</h1>
    <p class="small">Create invoices and ID cards entirely client-side. Upload photos from your phone and print or download â€” no uploads.</p>

    <div class="tabs" role="tablist" aria-label="Tools">
      <button class="tab active" data-target="invoice" role="tab" id="tab-invoice">Invoice Builder</button>
      <button class="tab" data-target="idcard" role="tab" id="tab-id">ID Card Designer</button>
    </div>
  </section>

  <!-- Main Grid -->
  <main class="grid" role="main">
    <div>
      <!-- INVOICE -->
      <section id="invoice" class="card" aria-labelledby="invTitle">
        <h2 id="invTitle">Invoice Builder</h2>
        <p class="hint">Create invoices quickly â€” add items, set tax & discount, print or export. Everything runs in your browser (no uploads).</p>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <input id="companyName" type="text" placeholder="Company name (leave blank to hide on print)" />
          <input id="companyAddr" type="text" placeholder="Company address (optional)" />
          <input id="invoiceNo" type="text" placeholder="Invoice # (optional)" />
          <input id="invoiceDate" type="date" value="" />
          <input id="customerName" type="text" placeholder="Customer name (optional)" />
          <select id="status"><option>Unpaid</option><option>Paid</option><option>Draft</option></select>
          <textarea id="note" placeholder="Note / memo (optional)" style="grid-column:1/3"></textarea>
        </div>

        <table class="table" aria-label="Invoice items" style="margin-top:18px">
          <thead>
            <tr><th>Description</th><th style="width:80px">Qty</th><th style="width:120px">Unit</th><th style="width:90px">Tax %</th><th style="width:120px">Line total</th></tr>
          </thead>
          <tbody id="itemsBody">
            <tr>
              <td><input class="it-desc" type="text" placeholder="Item description" /></td>
              <td><input class="it-qty" type="number" value="1" min="0" /></td>
              <td><input class="it-unit" type="number" value="0" step="0.01" /></td>
              <td><input class="it-tax" type="number" value="0" /></td>
              <td class="it-total">0.00</td>
            </tr>
          </tbody>
        </table>

        <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
          <button id="addItem" class="primary">Add Item</button>
          <button id="clearItems" class="ghost">Clear Items</button>
          <div style="flex:1"></div>
        </div>

        <div style="margin-top:12px">
          <label class="sm">Discount (%)</label>
          <input id="globalDiscount" type="number" placeholder="0" value="0" />
          <label class="sm" style="margin-top:8px">Global Tax (%)</label>
          <input id="globalTax" type="number" placeholder="0" value="0" />
        </div>

        <div class="summary" aria-live="polite" style="margin-top:18px">
          <div>Subtotal: <span id="subTotal">0.00</span></div>
          <div>Tax: <span id="taxTotal">0.00</span></div>
          <div>Discount: <span id="discTotal">0.00</span></div>
          <div style="font-size:20px;margin-top:6px">Total: <span id="finalTotal">0.00</span></div>
        </div>

        <div style="display:flex;gap:10px;margin-top:18px;flex-wrap:wrap">
          <button id="printInvoice" class="primary">Print Invoice</button>
          <button id="exportInvoiceJSON" class="ghost">Export JSON</button>
          <button id="saveLocally" class="ghost">Save Locally</button>
          <button id="loadLast" class="ghost">Load Last</button>
          <button id="resetInvoice" class="ghost">Reset</button>
        </div>
      </section>

      <!-- ID CARD -->
      <section id="idcard" class="card hidden" aria-labelledby="idTitle">
        <h2 id="idTitle">ID Card Designer</h2>
        <p class="hint">Design a simple ID and download a PNG. Upload a photo from your phone and position it.</p>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <input id="idName" type="text" placeholder="Full name" />
          <input id="idRole" type="text" placeholder="Role / Title" />
          <input id="idCompany" type="text" placeholder="Company / Org" />
          <input id="idPhone" type="text" placeholder="Phone (optional)" />
          <input id="idEmail" type="text" placeholder="Email (optional)" />
          <input id="idDob" type="date" placeholder="DOB (optional)" />
          <textarea id="idAddress" placeholder="Address (optional)" style="grid-column:1/3"></textarea>
        </div>

        <div style="margin-top:12px">
          <label class="sm">Photo</label>
          <input id="idPhotoInput" type="file" accept="image/*" />
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <button id="clearPhoto" class="ghost">Clear Photo</button>
            <div class="sm" id="photoInfo"></div>
          </div>
        </div>

        <div id="idCanvasWrap" style="margin-top:12px;border-radius:12px;overflow:hidden;background:linear-gradient(180deg,#fff,#f8fbff);height:220px;display:flex;align-items:center;justify-content:center">
          <canvas id="idCanvas" width="600" height="350" style="width:100%;height:auto;max-height:320px"></canvas>
        </div>

        <div style="display:flex;gap:10px;margin-top:12px">
          <button id="downloadId" class="primary">Download ID PNG</button>
          <button id="saveId" class="ghost">Save ID (local)</button>
          <button id="loadId" class="ghost">Load ID</button>
        </div>
        <div class="sm" style="margin-top:12px">Tip: upload a square headshot for best results. Saved items are stored only in your browser (localStorage).</div>
      </section>
    </div>

    <!-- Right panel -->
    <aside>
      <div class="feature-panel">
        <div style="font-weight:900;margin-bottom:10px">PirateRuler Tools</div>

        <div class="feature">
          <div class="f-icon">âš¡</div>
          <div>
            <div class="f-title">Fast & Local</div>
            <div class="f-desc">Everything runs in your browser for speed and privacy.</div>
          </div>
        </div>

        <div class="feature" style="margin-top:12px">
          <div class="f-icon" style="background:linear-gradient(135deg,#8ee36b,#2bbf6f)">ðŸ“±</div>
          <div>
            <div class="f-title">Mobile-friendly</div>
            <div class="f-desc">Upload screenshots & photos from your phone camera roll.</div>
          </div>
        </div>

        <div style="margin-top:12px;padding:12px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.96),rgba(255,255,255,0.98));box-shadow:var(--shadow-sm)">
          <div style="font-weight:800">Quick tips</div>
          <ul class="sm" style="margin:8px 0 0 18px;padding:0">
            <li>Use browser Print to save invoices as PDF.</li>
            <li>iOS photos sometimes need Edit â†’ Done to allow pixel reading â€” re-save if errors occur.</li>
            <li>Saved invoices & IDs are stored only in your browser (localStorage).</li>
          </ul>
        </div>
      </div>
    </aside>
  </main>

  <!-- Footer -->
  <footer>
    <a class="visit" href="https://pirateruler.com" target="_blank" rel="noopener noreferrer">Visit PirateRuler.com</a>
    <div style="height:12px"></div>
    <small class="muted">Â© <span id="year"></span> PirateRuler â€” Invoice & ID Maker (client-side)</small>
  </footer>

  <!-- Sidebar (links only, no underlines) -->
  <aside id="sidebar" class="sidebar" role="dialog" aria-modal="true" aria-hidden="true">
    <div style="display:flex;justify-content:flex-end"><button id="closeSidebar" class="ghost">Close</button></div>
    <h3 style="margin-top:6px">Quick links</h3>
    <p class="muted">Backup & resources</p>
    <nav class="nav-list" aria-label="PirateRuler quick links">
      <a href="https://www.pirateruler.com/post/about.html" target="_blank" rel="noopener noreferrer">About â€” PirateRuler</a>
      <a href="https://www.pirateruler.com/post/privacy.html" target="_blank" rel="noopener noreferrer">Privacy Policy</a>
      <a href="https://www.pirateruler.com/post/contact.html" target="_blank" rel="noopener noreferrer">Contact</a>
      <a href="https://www.pirateruler.com/post/terms.html" target="_blank" rel="noopener noreferrer">Terms & Service</a>
    </nav>
    <div class="backup">If the site is offline visit PirateRuler for backups:<br><a href="https://pirateruler.com" target="_blank" rel="noopener noreferrer">pirateruler.com</a></div>
  </aside>

</div>

<script>
  // small helpers
  const el = id => document.getElementById(id);
  document.getElementById('year').textContent = new Date().getFullYear();

  // Theme selector
  const root = document.documentElement;
  const themeBtn = el('themeBtn');
  const themeList = document.querySelector('.theme-list');
  (function initTheme(){
    const saved = localStorage.getItem('pr-theme') || 'light';
    applyTheme(saved);
  })();
  themeBtn.addEventListener('click', e => {
    const list = document.querySelector('#themeList');
    list.style.display = list.style.display === 'block' ? 'none' : 'block';
  });
  document.querySelectorAll('.theme-item').forEach(it => it.addEventListener('click', (e) => {
    const t = e.currentTarget.dataset.theme;
    applyTheme(t);
    document.querySelector('#themeList').style.display = 'none';
  }));
  function applyTheme(t){
    ['dark','ocean','sunset'].forEach(c => root.classList.remove(c));
    if(t === 'dark') { root.classList.add('dark'); themeBtn.textContent = 'Dark â–¾'; localStorage.setItem('pr-theme','dark'); }
    else if(t === 'ocean') { root.classList.add('ocean'); themeBtn.textContent = 'Ocean â–¾'; localStorage.setItem('pr-theme','ocean'); }
    else if(t === 'sunset') { root.classList.add('sunset'); themeBtn.textContent = 'Sunset â–¾'; localStorage.setItem('pr-theme','sunset'); }
    else { themeBtn.textContent = 'Light â–¾'; localStorage.setItem('pr-theme','light'); }
  }

  // Sidebar
  const sidebar = el('sidebar'), hambBtn = el('hambBtn'), closeSidebar = el('closeSidebar');
  function openSidebar(){ sidebar.classList.add('open'); sidebar.setAttribute('aria-hidden','false'); }
  function closeSB(){ sidebar.classList.remove('open'); sidebar.setAttribute('aria-hidden','true'); }
  hambBtn.addEventListener('click', openSidebar);
  closeSidebar.addEventListener('click', closeSB);
  document.addEventListener('click', (e)=> {
    if (!sidebar.classList.contains('open')) return;
    if (!sidebar.contains(e.target) && !hambBtn.contains(e.target)) closeSB();
  });

  // Tabs (start at invoice)
  const tabs = Array.from(document.querySelectorAll('.tab'));
  function showTab(id){
    document.querySelectorAll('main section.card').forEach(s => s.classList.add('hidden'));
    const elTab = document.getElementById(id);
    if(elTab) elTab.classList.remove('hidden');
    tabs.forEach(t => t.classList.toggle('active', t.dataset.target === id));
    // short scroll to top of section
    setTimeout(()=> {
      const rect = elTab.getBoundingClientRect();
      if(rect) window.scrollTo({top: window.scrollY + rect.top - 70, behavior:'smooth'});
    }, 70);
  }
  tabs.forEach(t => t.addEventListener('click', ()=> showTab(t.dataset.target)));
  showTab('invoice');

  /* =========================
     Invoice logic (simple)
     ========================= */
  const itemsBody = el('itemsBody');
  const addItemBtn = el('addItem');
  const clearItemsBtn = el('clearItems');
  const globalTax = el('globalTax');
  const globalDiscount = el('globalDiscount');
  const subTotalEl = el('subTotal');
  const taxTotalEl = el('taxTotal');
  const discTotalEl = el('discTotal');
  const finalTotalEl = el('finalTotal');

  function recalcInvoice(){
    const rows = Array.from(itemsBody.querySelectorAll('tr'));
    let subtotal = 0, taxTotal = 0;
    rows.forEach(r => {
      const qty = parseFloat(r.querySelector('.it-qty').value || 0);
      const unit = parseFloat(r.querySelector('.it-unit').value || 0);
      const tax = parseFloat(r.querySelector('.it-tax').value || 0);
      const line = qty * unit;
      const lineTax = line * (tax/100);
      subtotal += line;
      taxTotal += lineTax;
      r.querySelector('.it-total').textContent = (line + lineTax).toFixed(2);
    });
    // apply global tax and discount
    const gTaxPct = parseFloat(globalTax.value || 0);
    const gDiscPct = parseFloat(globalDiscount.value || 0);
    const gTax = subtotal * (gTaxPct/100);
    const gDisc = subtotal * (gDiscPct/100);
    const totalTax = taxTotal + gTax;
    const total = Math.max(0, subtotal + totalTax - gDisc);
    subTotalEl.textContent = subtotal.toFixed(2);
    taxTotalEl.textContent = totalTax.toFixed(2);
    discTotalEl.textContent = gDisc.toFixed(2);
    finalTotalEl.textContent = total.toFixed(2);
  }

  addItemBtn.addEventListener('click', ()=> {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="it-desc" type="text" placeholder="Item description" /></td>
      <td><input class="it-qty" type="number" value="1" min="0" /></td>
      <td><input class="it-unit" type="number" value="0" step="0.01" /></td>
      <td><input class="it-tax" type="number" value="0" /></td>
      <td class="it-total">0.00</td>
    `;
    itemsBody.appendChild(tr);
    hookupRow(tr);
    recalcInvoice();
  });

  function hookupRow(tr){
    ['it-qty','it-unit','it-tax'].forEach(cls => {
      const input = tr.querySelector('.' + cls);
      if(input) input.addEventListener('input', recalcInvoice);
    });
  }

  // hookup initial rows
  Array.from(itemsBody.querySelectorAll('tr')).forEach(hookupRow);
  clearItemsBtn.addEventListener('click', ()=> {
    itemsBody.innerHTML = '';
    addItemBtn.click();
    recalcInvoice();
  });

  [globalTax, globalDiscount].forEach(inp => inp.addEventListener('input', recalcInvoice));

  // export / save invoice
  el('exportInvoiceJSON').addEventListener('click', ()=>{
    const invoice = gatherInvoice();
    const blob = new Blob([JSON.stringify(invoice, null, 2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'invoice.json'; a.click(); URL.revokeObjectURL(a.href);
  });
  el('saveLocally').addEventListener('click', ()=>{
    localStorage.setItem('pr-last-invoice', JSON.stringify(gatherInvoice()));
    alert('Invoice saved locally in your browser.');
  });
  el('loadLast').addEventListener('click', ()=>{
    const s = localStorage.getItem('pr-last-invoice');
    if(!s) return alert('No saved invoice found.');
    try{
      const inv = JSON.parse(s);
      populateInvoice(inv);
      recalcInvoice();
      alert('Loaded last invoice.');
    }catch(e){ alert('Failed to load invoice.'); }
  });
  el('resetInvoice').addEventListener('click', ()=> {
    if(!confirm('Reset invoice?')) return;
    el('companyName').value=''; el('companyAddr').value=''; el('invoiceNo').value=''; el('invoiceDate').value=''; el('customerName').value=''; el('note').value='';
    itemsBody.innerHTML = '';
    addItemBtn.click();
    globalTax.value = '0'; globalDiscount.value = '0';
    recalcInvoice();
  });

  function gatherInvoice(){
    const rows = Array.from(itemsBody.querySelectorAll('tr')).map(r => ({
      description: r.querySelector('.it-desc').value,
      qty: parseFloat(r.querySelector('.it-qty').value || 0),
      unit: parseFloat(r.querySelector('.it-unit').value || 0),
      tax: parseFloat(r.querySelector('.it-tax').value || 0),
      lineTotal: parseFloat(r.querySelector('.it-total').textContent || 0)
    }));
    return {
      companyName: el('companyName').value,
      companyAddr: el('companyAddr').value,
      invoiceNo: el('invoiceNo').value,
      invoiceDate: el('invoiceDate').value,
      customerName: el('customerName').value,
      status: el('status').value,
      note: el('note').value,
      items: rows,
      globalTax: parseFloat(globalTax.value || 0),
      globalDiscount: parseFloat(globalDiscount.value || 0),
      totals: {subtotal: parseFloat(subTotalEl.textContent||0), tax: parseFloat(taxTotalEl.textContent||0), discount: parseFloat(discTotalEl.textContent||0), total: parseFloat(finalTotalEl.textContent||0)}
    };
  }

  function populateInvoice(inv){
    el('companyName').value = inv.companyName || '';
    el('companyAddr').value = inv.companyAddr || '';
    el('invoiceNo').value = inv.invoiceNo || '';
    el('invoiceDate').value = inv.invoiceDate || '';
    el('customerName').value = inv.customerName || '';
    el('status').value = inv.status || 'Unpaid';
    el('note').value = inv.note || '';
    itemsBody.innerHTML = '';
    if(inv.items && inv.items.length){
      inv.items.forEach(it => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><input class="it-desc" value="${escapeHtml(it.description||'')}" /></td>
                        <td><input class="it-qty" type="number" value="${it.qty||0}" /></td>
                        <td><input class="it-unit" type="number" value="${it.unit||0}" step="0.01" /></td>
                        <td><input class="it-tax" type="number" value="${it.tax||0}" /></td>
                        <td class="it-total">${(it.lineTotal||0).toFixed(2)}</td>`;
        itemsBody.appendChild(tr); hookupRow(tr);
      });
    } else addItemBtn.click();
    globalTax.value = inv.globalTax || 0; globalDiscount.value = inv.globalDiscount || 0;
  }

  function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // Print invoice: create printable window markup styled simply to look like a real bill.
  el('printInvoice').addEventListener('click', ()=>{
    const invoice = gatherInvoice();
    const printHtml = buildPrintHtml(invoice);
    const w = window.open('', '_blank');
    w.document.write(printHtml);
    w.document.close();
    // wait a bit then focus/print
    setTimeout(()=> { w.focus(); w.print(); }, 300);
  });

  function buildPrintHtml(inv){
    // simple CSS inline for print
    const company = inv.companyName || '';
    const companyBlock = company ? `<div style="text-align:center;font-weight:900;font-size:28px;margin-bottom:6px">${escapeHtml(company)}</div>
      <div style="text-align:center;color:#666;margin-bottom:12px">${escapeHtml(inv.companyAddr||'')}</div>` : '';
    const itemsRows = inv.items.map(it => `<tr>
      <td style="padding:6px;border-bottom:1px solid #eee">${escapeHtml(it.description)}</td>
      <td style="padding:6px;border-bottom:1px solid #eee;text-align:right">${it.qty}</td>
      <td style="padding:6px;border-bottom:1px solid #eee;text-align:right">${(it.unit||0).toFixed(2)}</td>
      <td style="padding:6px;border-bottom:1px solid #eee;text-align:right">${(it.tax||0).toFixed(2)}</td>
      <td style="padding:6px;border-bottom:1px solid #eee;text-align:right">${(it.lineTotal||0).toFixed(2)}</td>
    </tr>`).join('');
    const totals = inv.totals || {subtotal:0,tax:0,discount:0,total:0};
    return `<!doctype html><html><head><meta charset="utf-8"><title>Invoice ${escapeHtml(inv.invoiceNo||'')}</title>
      <style>body{font-family:Arial,Helvetica,sans-serif;padding:28px;color:#111} table{width:100%;border-collapse:collapse} th{font-weight:700;color:#444;text-align:left;padding:6px} .right{text-align:right}</style></head><body>
      ${companyBlock}
      <div style="display:flex;justify-content:space-between;margin-bottom:8px">
        <div>Invoice #: <strong>${escapeHtml(inv.invoiceNo||'')}</strong></div>
        <div>Date: <strong>${escapeHtml(inv.invoiceDate||new Date().toLocaleDateString())}</strong></div>
      </div>
      <div style="margin-bottom:12px">Bill to: <strong>${escapeHtml(inv.customerName||'')}</strong></div>
      <table><thead><tr><th>Description</th><th style="text-align:right">Qty</th><th style="text-align:right">Unit</th><th style="text-align:right">Tax%</th><th style="text-align:right">Line total</th></tr></thead><tbody>
      ${itemsRows}
      </tbody></table>
      <div style="margin-top:18px;display:flex;justify-content:flex-end">
        <table style="width:320px">
          <tr><td style="padding:6px">Subtotal</td><td style="padding:6px;text-align:right">${totals.subtotal.toFixed(2)}</td></tr>
          <tr><td style="padding:6px">Tax</td><td style="padding:6px;text-align:right">${totals.tax.toFixed(2)}</td></tr>
          <tr><td style="padding:6px">Discount</td><td style="padding:6px;text-align:right">${totals.discount.toFixed(2)}</td></tr>
          <tr style="font-weight:900"><td style="padding:6px">Total</td><td style="padding:6px;text-align:right">${totals.total.toFixed(2)}</td></tr>
        </table>
      </div>
      <div style="margin-top:28px;color:#666">${escapeHtml(inv.note||'')}</div>
      </body></html>`;
  }

  // initial invoice setup
  addItemBtn.click();
  recalcInvoice();

  /* =========================
     ID card designer (canvas)
     ========================= */
  const idCanvas = el('idCanvas');
  const idCtx = idCanvas.getContext('2d');
  const idPhotoInput = el('idPhotoInput');
  const clearPhotoBtn = el('clearPhoto');
  const photoInfo = el('photoInfo');
  const downloadIdBtn = el('downloadId');
  const saveIdBtn = el('saveId');
  const loadIdBtn = el('loadId');

  let idPhoto = null; // Image object
  function drawId(){
    // clear
    idCtx.clearRect(0,0,idCanvas.width,idCanvas.height);
    // background
    idCtx.fillStyle = '#ffffff';
    idCtx.fillRect(0,0,idCanvas.width,idCanvas.height);
    // small top bar
    idCtx.fillStyle = '#f4f9ff';
    idCtx.fillRect(0,0,idCanvas.width,72);
    // company
    const company = el('idCompany').value || '';
    idCtx.fillStyle = '#0b2130';
    idCtx.font = 'bold 20px Inter, Arial';
    idCtx.textAlign = 'left';
    idCtx.fillText(company, 140, 40);
    // photo slot
    idCtx.fillStyle = '#e9f2f8';
    idCtx.fillRect(18, 18, 104, 104);
    // draw photo if present (fit into 104x104)
    if(idPhoto){
      const w = idPhoto.naturalWidth, h = idPhoto.naturalHeight;
      const ratio = Math.min(104/w, 104/h);
      const dw = w*ratio, dh = h*ratio;
      const dx = 18 + (104 - dw)/2, dy = 18 + (104 - dh)/2;
      idCtx.drawImage(idPhoto, dx, dy, dw, dh);
    }
    // name & role
    idCtx.fillStyle = '#0b2130';
    idCtx.font = 'bold 18px Inter, Arial';
    idCtx.textAlign = 'left';
    idCtx.fillText(el('idName').value || 'Full name', 140, 92);
    idCtx.font = '14px Inter, Arial';
    idCtx.fillStyle = '#586673';
    idCtx.fillText(el('idRole').value || 'Role / Title', 140, 116);
    // optional details printed smaller
    idCtx.font = '12px Inter, Arial';
    idCtx.fillStyle = '#6b7480';
    let y = 148;
    const fields = [
      {label:'Phone', value: el('idPhone').value},
      {label:'Email', value: el('idEmail').value},
      {label:'DOB', value: el('idDob').value},
      {label:'Address', value: el('idAddress').value}
    ];
    fields.forEach(f => {
      if(f.value){
        idCtx.fillText(`${f.label}: ${f.value}`, 20, y);
        y += 18;
      }
    });
    // subtle border
    idCtx.strokeStyle = 'rgba(0,0,0,0.04)';
    idCtx.strokeRect(0,0,idCanvas.width,idCanvas.height);
  }

  // redraw whenever inputs change
  ['idName','idRole','idCompany','idPhone','idEmail','idDob','idAddress'].forEach(id => {
    el(id).addEventListener('input', drawId);
  });

  idPhotoInput.addEventListener('change', (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    const url = URL.createObjectURL(f);
    const img = new Image();
    img.onload = ()=>{
      idPhoto = img;
      photoInfo.textContent = `${f.name} (${Math.round(f.size/1024)}KB)`;
      drawId();
      URL.revokeObjectURL(url);
    };
    img.onerror = ()=> { alert('Could not load photo. Try re-saving the image from your phone and uploading again.'); URL.revokeObjectURL(url); }
    img.src = url;
  });

  clearPhotoBtn.addEventListener('click', ()=> {
    idPhoto = null;
    idPhotoInput.value = '';
    photoInfo.textContent = '';
    drawId();
  });

  downloadIdBtn.addEventListener('click', ()=>{
    const url = idCanvas.toDataURL('image/png');
    const a = document.createElement('a'); a.href = url; a.download = 'id-card.png'; a.click();
  });

  saveIdBtn.addEventListener('click', ()=>{
    const state = {
      name: el('idName').value, role: el('idRole').value, company: el('idCompany').value,
      phone: el('idPhone').value, email: el('idEmail').value, dob: el('idDob').value, address: el('idAddress').value,
      photo: idPhoto ? idCanvas.toDataURL('image/png') : null
    };
    localStorage.setItem('pr-saved-id', JSON.stringify(state));
    alert('ID saved locally in your browser.');
  });

  loadIdBtn.addEventListener('click', ()=>{
    const s = localStorage.getItem('pr-saved-id');
    if(!s) return alert('No saved ID found.');
    try{
      const st = JSON.parse(s);
      el('idName').value = st.name || '';
      el('idRole').value = st.role || '';
      el('idCompany').value = st.company || '';
      el('idPhone').value = st.phone || '';
      el('idEmail').value = st.email || '';
      el('idDob').value = st.dob || '';
      el('idAddress').value = st.address || '';
      if(st.photo){
        const img = new Image();
        img.onload = ()=> { idPhoto = img; drawId(); };
        img.src = st.photo;
      } else { idPhoto = null; drawId(); }
      alert('Loaded saved ID from browser storage.');
    }catch(e){ alert('Failed to load ID.'); }
  });

  // initial draw
  drawId();

  /* Accessibility: close theme dropdown on outside click */
  document.addEventListener('click', (e)=>{
    if(!document.getElementById('themeSelectWrap').contains(e.target)) document.getElementById('themeList').style.display = 'none';
  });

  // Adjust sidebar width on small screens
  function updateSidebarWidth(){ if(window.innerWidth < 420) sidebar.style.width = '94vw'; else sidebar.style.width = '360px'; }
  window.addEventListener('resize', updateSidebarWidth);
  updateSidebarWidth();
</script>
</body>
</html>
